<mat-form-field *ngIf="control" appearance="fill" subscriptSizing="dynamic">
  <mat-label>Filter</mat-label>
  <mat-select [formControl]="control" (closed)="selectedCategoryGroupIndex = undefined" multiple>
    <mat-select-trigger>
      <span [ngSwitch]="control.value?.length">
        <span *ngSwitchCase="0">Geen</span>
        <span *ngSwitchCase="1">{{control.value?.at(0)}}</span>
        <span *ngSwitchCase="totalCategoryCount">Alles</span>
        <span *ngSwitchCase="undefined">Alles</span>
        <span *ngSwitchDefault>Meerdere ({{control.value?.length}})</span>
      </span>
    </mat-select-trigger>

    <mat-expansion-panel class="filter" *ngFor="let group of categoryGroups | keyvalue; let i = index;"
      [expanded]="i === selectedCategoryGroupIndex"
      (expandedChange)="selectedCategoryGroupIndex = $event ? i : selectedCategoryGroupIndex === i ? undefined : selectedCategoryGroupIndex"
      >
      <mat-expansion-panel-header>
        <mat-checkbox 
        (change)="setCategoryGroup(group.value, $event.checked)"
        [checked]="isAllChecked(group.value)"
        (click)="$event.stopPropagation()" 
        (keydown)="$event.stopPropagation()">
        {{ group.key }}   <span *ngIf="isAnyChecked(group.value) && !isAllChecked(group.value) && selectedCategoryGroupIndex !== i">({{countChecked(group.value)}}/{{group.value.length}})</span>
        </mat-checkbox>
      </mat-expansion-panel-header>
      <mat-option *ngFor="let category of group.value"
        [value]="category.key">
        {{category.label}}
      </mat-option>
    </mat-expansion-panel>
  </mat-select>
</mat-form-field>